<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSONP 跨域请求演示</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        background-color: #f4f4f4;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      .explanation {
        background-color: #fffde7;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #ffd600;
        border-radius: 3px;
      }
      .demo-section {
        margin-bottom: 30px;
      }
      .demo-container {
        display: flex;
        flex-wrap: wrap;
      }
      .result {
        flex: 1;
        min-width: 300px;
        margin: 10px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .content {
        min-height: 100px;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .timestamp {
        color: #888;
        font-size: 0.8em;
      }
      button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      .loading {
        color: #888;
        font-style: italic;
      }
      .error {
        color: #e53935;
        background-color: #ffebee;
        padding: 8px;
        border-radius: 3px;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
      code {
        font-family: Consolas, Monaco, "Andale Mono", monospace;
        font-size: 14px;
      }
      .code-block {
        margin: 15px 0;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .code-header {
        background-color: #eee;
        padding: 5px 10px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
      }
      .cors-failed {
        background-color: #ffebee;
      }
      .jsonp-success {
        background-color: #e8f5e9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>JSONP 跨域请求演示</h1>
        <p>这个示例演示了 JSONP 技术如何解决跨域请求的问题</p>
        <p>
          <strong>静态服务器：</strong> http://localhost:3000<br />
          <strong>API 服务器：</strong> http://localhost:3001
        </p>
      </header>

      <div class="explanation">
        <h2>什么是 JSONP？</h2>
        <p>
          JSONP（JSON with
          Padding）是一种跨域通信技术，它利用了&lt;script&gt;标签没有跨域限制的特性来实现跨域数据传输。
        </p>
        <p>原理：</p>
        <ol>
          <li>
            客户端动态创建一个&lt;script&gt;标签，并设置其src属性为跨域的URL
          </li>
          <li>在URL中添加一个回调函数名作为参数</li>
          <li>
            服务器返回一段JavaScript代码，这段代码会调用指定的回调函数，并将数据作为参数传入
          </li>
          <li>
            当脚本加载完成后，浏览器会执行这段JavaScript代码，从而触发回调函数
          </li>
        </ol>
      </div>

      <div class="demo-section">
        <h2>1. 常规的 AJAX 请求 (同源策略限制)</h2>
        <div class="demo-container">
          <div class="result">
            <h3>直接使用 fetch API:</h3>
            <div class="content" id="fetch-result"></div>
            <button id="fetch-btn">尝试直接请求 JSON 数据</button>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>2. 基本 JSONP 实现</h2>
        <div class="demo-container">
          <div class="result">
            <h3>动态创建 script 标签:</h3>
            <div class="content" id="basic-jsonp-result"></div>
            <button id="basic-jsonp-btn">使用 JSONP 跨域请求</button>
          </div>

          <div class="result">
            <h3>JSONP 代码实现:</h3>
            <div class="code-block">
              <div class="code-header">客户端代码</div>
              <pre><code>function jsonpRequest(url, callback) {
  const script = document.createElement('script');
  const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
  
  // 全局定义回调函数
  window[callbackName] = function(data) {
    callback(data);
    document.body.removeChild(script);
    delete window[callbackName];
  };
  
  // 添加回调参数到URL
  script.src = url + 
    (url.includes('?') ? '&' : '?') + 
    'callback=' + callbackName;
  
  document.body.appendChild(script);
}</code></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>3. 使用命名空间的 JSONP</h2>
        <div class="demo-container">
          <div class="result">
            <h3>命名空间回调 1:</h3>
            <div class="content" id="ns-jsonp1-result"></div>
            <button
              class="ns-jsonp-btn"
              data-target="ns-jsonp1"
              data-callback="callback1"
            >
              调用 jsonp.callback1
            </button>
          </div>

          <div class="result">
            <h3>命名空间回调 2:</h3>
            <div class="content" id="ns-jsonp2-result"></div>
            <button
              class="ns-jsonp-btn"
              data-target="ns-jsonp2"
              data-callback="callback2"
            >
              调用 jsonp.callback2
            </button>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>JSONP 的优缺点</h2>
        <div class="explanation">
          <h3>优点:</h3>
          <ul>
            <li>兼容性好，在古老的浏览器中也能工作</li>
            <li>不需要服务器端配置 CORS 头</li>
            <li>可以绕过同源策略的限制</li>
          </ul>

          <h3>缺点:</h3>
          <ul>
            <li>只支持 GET 请求，无法发送 POST 等其他类型的请求</li>
            <li>存在安全风险，容易受到跨站脚本攻击</li>
            <li>错误处理机制不完善</li>
            <li>现代web应用应优先使用 CORS 解决跨域问题</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      // 通用的显示函数
      function displayResult(elementId, data, isError = false) {
        const el = document.getElementById(elementId);
        const timestamp = new Date().toLocaleString();

        let html = `<p class="timestamp">时间: ${timestamp}</p>`;

        if (isError) {
          html += `<div class="error">${data}</div>`;
        } else if (typeof data === "object") {
          html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          html += `<p>${data}</p>`;
        }

        el.innerHTML = html;

        // 添加视觉反馈
        el.classList.remove("loading");
        if (isError) {
          el.classList.add("cors-failed");
          el.classList.remove("jsonp-success");
        } else {
          el.classList.add("jsonp-success");
          el.classList.remove("cors-failed");
        }
      }

      // 显示加载中状态
      function showLoading(elementId) {
        const el = document.getElementById(elementId);
        el.innerHTML = '<p class="loading">正在加载数据...</p>';
        el.classList.add("loading");
      }

      // 1. 常规 fetch 请求 (会因为同源策略失败)
      document
        .getElementById("fetch-btn")
        .addEventListener("click", function () {
          showLoading("fetch-result");

          fetch("http://localhost:3001/api/data")
            .then((response) => response.json())
            .then((data) => {
              displayResult("fetch-result", data);
            })
            .catch((error) => {
              displayResult(
                "fetch-result",
                `请求失败: ${error.message}。这是因为同源策略限制了跨域请求。`,
                true
              );
            });
        });

      // 2. 基本 JSONP 实现
      function jsonpRequest(url, callback) {
        const script = document.createElement("script");
        const callbackName =
          "jsonp_callback_" + Math.round(100000 * Math.random());

        // 全局定义回调函数
        window[callbackName] = function (data) {
          callback(data);
          document.body.removeChild(script);
          delete window[callbackName];
        };

        // 添加回调参数和时间戳(防缓存)到URL
        script.src =
          url +
          (url.includes("?") ? "&" : "?") +
          "callback=" +
          callbackName +
          "&_t=" +
          new Date().getTime();

        // 错误处理
        script.onerror = function () {
          callback(null, new Error("JSONP 请求失败"));
          document.body.removeChild(script);
          delete window[callbackName];
        };

        document.body.appendChild(script);
      }

      document
        .getElementById("basic-jsonp-btn")
        .addEventListener("click", function () {
          showLoading("basic-jsonp-result");

          jsonpRequest(
            "http://localhost:3001/api/jsonp",
            function (data, error) {
              if (error) {
                displayResult(
                  "basic-jsonp-result",
                  `JSONP 请求出错: ${error.message}`,
                  true
                );
              } else {
                displayResult("basic-jsonp-result", data);
              }
            }
          );
        });

      // 3. 命名空间形式的 JSONP
      var jsonp = {
        callback1: function (data) {
          displayResult("ns-jsonp1-result", data);
        },
        callback2: function (data) {
          displayResult("ns-jsonp2-result", data);
        },
      };

      function loadNamespacedJsonp(url, callbackId) {
        showLoading(callbackId + "-result");

        const script = document.createElement("script");
        script.src = url + "&_t=" + new Date().getTime(); // 添加时间戳防止缓存

        script.onerror = function () {
          displayResult(
            callbackId + "-result",
            `JSONP 请求失败。请确认API服务器 (localhost:3001) 正在运行。`,
            true
          );
          this.remove();
        };

        script.onload = function () {
          this.remove();
        };

        document.body.appendChild(script);
      }

      document.querySelectorAll(".ns-jsonp-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const target = this.getAttribute("data-target");
          const callback = this.getAttribute("data-callback");

          loadNamespacedJsonp(
            `http://localhost:3001/api/jsonp/${callback}?namespace=jsonp`,
            target
          );
        });
      });
    </script>
  </body>
</html>
