<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>withCredentials 简单示例</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      .controls {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      button {
        padding: 8px 12px;
        margin-right: 10px;
        cursor: pointer;
      }
      #result {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        min-height: 100px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      #debug {
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h2>XMLHttpRequest withCredentials 演示</h2>
    <p>此示例演示 withCredentials 属性如何控制跨域请求是否携带 Cookie</p>

    <div
      id="fileProtocolWarning"
      style="
        display: none;
        background-color: #ffeeee;
        border: 1px solid red;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
      "
    >
      <strong>⚠️ 警告:</strong> 您正在通过文件协议(file://)访问此页面。<br />
      为了正确测试 withCredentials 功能，请通过 HTTP 服务器访问此页面。<br />
      <code>cd /Users/gufeng/self/learn-network && npx http-server .</code
      ><br />
      然后访问
      <a id="httpLink" href="#"
        >http://localhost:8080/examples/XMLHttpRequest/withCredentials.html</a
      >
    </div>

    <div class="controls">
      <h3>测试步骤</h3>
      <p>1. 首先点击"设置 Cookie"按钮在服务器端设置一个 Cookie</p>
      <p>2. 然后选择是否启用 withCredentials，点击"检查 Cookie"验证</p>

      <div>
        <label>
          <input type="checkbox" id="credentialsCheck" checked /> 启用
          withCredentials
        </label>
      </div>
      <div style="margin-top: 15px">
        <button id="setCookieBtn">设置 Cookie</button>
        <button id="checkCookieBtn">检查 Cookie</button>
        <button id="clearCookieBtn">清除 Cookie</button>
      </div>

      <div style="margin-top: 15px">
        <label>
          服务器地址:
          <input
            type="text"
            id="serverUrl"
            value="http://localhost:8080"
            style="width: 200px"
          />
        </label>
      </div>
    </div>

    <h3>结果:</h3>
    <div id="result">尚未发送请求...</div>

    <div id="debug"></div>

    <script>
      const credentialsCheck = document.getElementById("credentialsCheck");
      const setCookieBtn = document.getElementById("setCookieBtn");
      const checkCookieBtn = document.getElementById("checkCookieBtn");
      const clearCookieBtn = document.getElementById("clearCookieBtn");
      const serverUrlInput = document.getElementById("serverUrl");
      const resultEl = document.getElementById("result");
      const debugEl = document.getElementById("debug");
      const fileWarningEl = document.getElementById("fileProtocolWarning");
      const httpLinkEl = document.getElementById("httpLink");

      // 显示浏览器中当前的 Cookie
      function showBrowserCookies() {
        debugEl.innerHTML = `<strong>当前浏览器 Cookie:</strong> ${
          document.cookie || "(无Cookie)"
        }`;
      }

      // 显示结果
      function showResult(message, success = true) {
        resultEl.innerHTML = message;
        resultEl.className = success ? "success" : "error";
        showBrowserCookies();
      }

      // 格式化 JSON 显示
      function formatJson(jsonString) {
        try {
          const obj = JSON.parse(jsonString);
          return JSON.stringify(obj, null, 2);
        } catch (e) {
          return jsonString;
        }
      }

      // 获取服务器基础URL
      function getServerBase() {
        return serverUrlInput.value.trim() || "http://localhost:8080";
      }

      // 检查是否通过文件协议访问
      function checkFileProtocol() {
        if (location.protocol === "file:") {
          fileWarningEl.style.display = "block";

          // 设置正确的HTTP链接
          const currentPath = location.pathname;
          const serverPort = 8080;
          httpLinkEl.href = `http://localhost:${serverPort}${currentPath}`;

          // 添加额外警告
          showResult(
            "⚠️ 您正在通过文件协议访问此页面，withCredentials 测试可能无法正常工作！\n" +
              "请通过 HTTP 服务器访问此页面以获得正确结果。",
            false
          );
        }
      }

      // 发送 XMLHttpRequest
      function sendRequest(endpoint, withCredentials) {
        resultEl.innerHTML = "<span class='info'>请求中...</span>";
        resultEl.className = "";

        const xhr = new XMLHttpRequest();
        const serverBase = getServerBase();
        const url = `${serverBase}${endpoint}`;

        xhr.onload = function () {
          try {
            const response = JSON.parse(xhr.responseText);
            showResult(formatJson(xhr.responseText), true);

            // 如果是检查 cookie 请求
            if (endpoint === "/api/check-cookie") {
              // 显示请求头和响应头详情，帮助调试
              let headerInfo = "\n\n--- 请求和响应详情 ---\n";
              headerInfo += `请求URL: ${url}\n`;
              headerInfo += `协议: ${location.protocol}\n`;
              headerInfo += `withCredentials: ${withCredentials}\n`;
              headerInfo += `状态码: ${xhr.status}\n`;

              // 检查关键的响应头
              const corsHeaders = {
                "Access-Control-Allow-Origin": xhr.getResponseHeader(
                  "Access-Control-Allow-Origin"
                ),
                "Access-Control-Allow-Credentials": xhr.getResponseHeader(
                  "Access-Control-Allow-Credentials"
                ),
              };

              headerInfo += `CORS 响应头: ${JSON.stringify(
                corsHeaders,
                null,
                2
              )}\n`;

              if (!response.hasCookie && withCredentials) {
                // 更详细的调试信息
                let debugMsg = "\n\n提示：Cookie 未检测到，可能是因为：\n";
                if (location.protocol === "file:") {
                  debugMsg +=
                    "- 您正在使用文件协议(file://)，大多数浏览器限制file://协议的Cookie\n";
                  debugMsg += "- 请通过HTTP服务器访问此页面\n";
                } else {
                  debugMsg += "- Cookie 设置失败或已过期\n";
                  debugMsg += "- SameSite 策略限制了 Cookie 的发送\n";
                }
                debugMsg += "- 服务器未正确设置CORS响应头\n";
                debugMsg += "- 浏览器的安全策略阻止了Cookie发送";

                showResult(
                  formatJson(xhr.responseText) + headerInfo + debugMsg,
                  false
                );
              } else {
                showResult(formatJson(xhr.responseText) + headerInfo, true);
              }
            }
          } catch (e) {
            showResult(
              `解析响应失败: ${e.message}\n${xhr.responseText}`,
              false
            );
          }
        };

        xhr.onerror = function () {
          showResult(
            "请求失败！可能原因：\n" +
              "1. 服务器未运行或无法访问\n" +
              "2. CORS 配置错误\n" +
              `3. withCredentials=${withCredentials} 但服务器响应头不匹配\n\n` +
              "详细错误: " +
              xhr.status,
            false
          );
        };

        try {
          xhr.open("GET", url, true);
          xhr.withCredentials = withCredentials;
          xhr.send();
          return `已发送请求到 ${url}\nwithCredentials: ${withCredentials}`;
        } catch (e) {
          showResult(`发送请求时出错: ${e.message}`, false);
          return `发送请求失败: ${e.message}`;
        }
      }

      // 设置 Cookie
      function setCookie() {
        showResult(sendRequest("/api/set-cookie", true));
      }

      // 检查 Cookie
      function checkCookie() {
        const useCredentials = credentialsCheck.checked;
        showResult(sendRequest("/api/check-cookie", useCredentials));
      }

      // 清除 Cookie (仅前端)
      function clearCookie() {
        document.cookie =
          "testCookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        showResult(
          "已尝试清除前端 Cookie。\n\n注意：这可能无法清除所有服务器设置的Cookie，特别是HttpOnly的Cookie。",
          true
        );
        showBrowserCookies();
      }

      // 事件监听
      setCookieBtn.addEventListener("click", setCookie);
      checkCookieBtn.addEventListener("click", checkCookie);
      clearCookieBtn.addEventListener("click", clearCookie);

      // 初始化
      showBrowserCookies();
      checkFileProtocol();
    </script>
  </body>
</html>
