<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket 客户端</title>
    <style>
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
      .info {
        background-color: #d9edf7;
        color: #31708f;
      }
      .message-input {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }
      .message-input input {
        flex-grow: 1;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      .message-input button {
        padding: 8px 15px;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket 握手演示</h1>
    <div id="status"></div>
    <div>
      <button id="sendMsg">发送测试消息</button>
      <button id="closeConn">关闭连接</button>
    </div>

    <div class="message-input">
      <input type="text" id="messageInput" placeholder="输入要发送的消息..." />
      <button id="sendCustomMsg">发送</button>
    </div>

    <script>
      const statusDiv = document.getElementById("status");
      const messageInput = document.getElementById("messageInput");

      function addStatus(message, type = "info") {
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        statusDiv.appendChild(div);
      }

      // 创建 WebSocket 连接
      const ws = new WebSocket("ws://localhost:8080");

      ws.onopen = function () {
        addStatus("WebSocket 连接已建立", "success");
      };

      ws.onerror = function (error) {
        console.error("WebSocket 错误：", error);
        addStatus(`WebSocket 错误：${error.type}`, "error");
      };

      ws.onclose = function (event) {
        console.log("WebSocket 关闭：", event);
        let reason;
        // 解释关闭代码
        switch (event.code) {
          case 1000:
            reason = "正常关闭";
            break;
          case 1001:
            reason = "终端离开";
            break;
          case 1002:
            reason = "协议错误";
            break;
          case 1003:
            reason = "接收到不可接受的数据";
            break;
          case 1005:
            reason = "没有状态码";
            break;
          case 1006:
            reason = "异常关闭";
            break;
          case 1007:
            reason = "接收到的数据帧类型不一致";
            break;
          case 1008:
            reason = "违反策略";
            break;
          case 1009:
            reason = "消息太大";
            break;
          case 1010:
            reason = "客户端请求协商失败";
            break;
          case 1011:
            reason = "服务器遇到未知情况";
            break;
          default:
            reason = "未知原因";
        }
        addStatus(
          `WebSocket 连接已关闭：${reason} (代码: ${event.code})`,
          "error"
        );
      };

      // 发送测试消息
      document.getElementById("sendMsg").onclick = function () {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send("测试消息");
          addStatus("已发送测试消息");
        } else {
          addStatus("连接未建立，无法发送消息", "error");
        }
      };

      // 发送自定义消息
      function sendCustomMessage() {
        if (ws.readyState === WebSocket.OPEN) {
          const message = messageInput.value.trim();
          if (message) {
            ws.send(message);
            addStatus(`已发送消息: "${message}"`);
            messageInput.value = ""; // 清空输入框
          }
        } else {
          addStatus("连接未建立，无法发送消息", "error");
        }
      }

      // 点击发送按钮
      document.getElementById("sendCustomMsg").onclick = sendCustomMessage;

      // 按下回车键发送
      messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendCustomMessage();
        }
      });

      // 手动关闭连接
      document.getElementById("closeConn").onclick = function () {
        if (ws.readyState === WebSocket.OPEN) {
          ws.close(1000, "用户主动关闭连接");
          addStatus("正在关闭连接...");
        } else {
          addStatus("连接已关闭或未建立", "info");
        }
      };
    </script>
  </body>
</html>
